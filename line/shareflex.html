<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Share Flex Message</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      text-align: center; 
      padding: 40px 20px;
      background: linear-gradient(135deg, #0066CC 0%, #004499 100%);
      color: white;
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 400px;
      width: 100%;
    }
    .loading { 
      font-size: 20px; 
      font-weight: 500;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .error, .success {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      backdrop-filter: blur(10px);
    }
    .icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="icon">üì®</div>
    <div class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <div id="error" class="error" style="display:none;"></div>
    <div id="success" class="success" style="display:none;"></div>
  </div>
  
  <script>
    const LIFF_ID = '1656032875-o6mwvLAQ';
    
    // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: https://script.google.com/macros/s/AKfycbxxx.../exec
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxnOgK17_ZsFmmZUJkRV8g4I8KULa9PSYkYti2qhlilWOQDByYZ0k4cNZlw-V_gGrl4Gg/exec';
    
    // Debug mode - ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á log
    const DEBUG = false;
    
    function debugLog(message, data = null) {
      // Log ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô console (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
      if (DEBUG) {
        console.log(message, data);
      }
    }
    
    liff.init({ liffId: LIFF_ID })
      .then(() => {
        debugLog('‚úÖ LIFF initialized successfully');
        
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode');
        const type = params.get('type');
        const flexId = params.get('flexId');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!liff.isInClient()) {
          showError('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô LINE', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô LINE App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÅ‡∏ä‡∏£‡πå');
          return;
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö parameters
        if (!mode || !type || !flexId) {
          showError('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô<br>mode: ${mode}<br>type: ${type}<br>flexId: ${flexId}`);
          return;
        }
        
        if (mode === 'share' && type === 'flex') {
          loadFlexFromServer(flexId);
        } else {
          showError('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', `mode: ${mode}, type: ${type}`);
        }
      })
      .catch(err => {
        showError('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message);
      });
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Flex ‡∏à‡∏≤‡∏Å Google Apps Script Web App
    async function loadFlexFromServer(flexId) {
      try {
        
        if (WEB_APP_URL === 'YOUR_WEB_APP_URL_HERE') {
          throw new Error('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WEB_APP_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î HTML');
        }
        
        const url = `${WEB_APP_URL}?action=getFlexData&flexId=${encodeURIComponent(flexId)}`;
        debugLog('üåê Request URL', { url });
        
        const response = await fetch(url);
        debugLog('üì• Response received', { 
          status: response.status, 
          ok: response.ok 
        });
        
        if (!response.ok) {
          throw new Error(`HTTP Error: ${response.status}`);
        }
        
        const data = await response.json();
        debugLog('üì¶ Data parsed', data);
        
        if (data.success) {
          debugLog('‚úÖ Data loaded successfully');
          shareFlexMessage(data.flexJson, data.altText);
        } else {
          throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Flex Message');
        }
        
      } catch (error) {
        debugLog('‚ùå Load Flex Error', { 
          message: error.message, 
          stack: error.stack 
        });
        showError('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 
          `${error.message}<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:<br>
          1. Web App URL ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á<br>
          2. Web App ‡πÑ‡∏î‡πâ Deploy ‡πÅ‡∏•‡πâ‡∏ß<br>
          3. Flex ID ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`
        );
      }
    }
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå Flex Message
    async function shareFlexMessage(flexJson, altText = 'Flex Message') {
      debugLog('üéØ Starting share process...', { altText });
      
      let displayName = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô';
      
      try {
        const profile = await liff.getProfile();
        displayName = profile.displayName;
        debugLog('üë§ User profile', { displayName });
      } catch (err) {
        debugLog('‚ö†Ô∏è Get Profile Error', err);
      }
      
      let flexContent;
      
      try {
        debugLog('üîÑ Parsing Flex JSON...');
        
        if (typeof flexJson === 'string') {
          const parsedData = JSON.parse(flexJson);
          debugLog('üìÑ Parsed JSON', parsedData);
          
          if (parsedData.type === 'flex') {
            flexContent = parsedData.contents;
            altText = parsedData.altText || altText;
          } else {
            flexContent = parsedData;
          }
        } else {
          flexContent = flexJson;
        }
        
        debugLog('‚úÖ Flex content ready', { 
          type: flexContent.type,
          altText: altText 
        });
        
      } catch (e) {
        debugLog('‚ùå Parse Error', e);
        showError('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• Flex Message ‡πÑ‡∏î‡πâ');
        return;
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Share Target Picker ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (!liff.isApiAvailable('shareTargetPicker')) {
        debugLog('‚ùå shareTargetPicker not available');
        showError('‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ', '‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á LINE ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó LINE App');
        return;
      }
      
      debugLog('‚úÖ shareTargetPicker is available');
      document.querySelector('.loading').innerHTML = 'üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå...';
      
      try {
        debugLog('üöÄ Opening share target picker...');
        
        await liff.shareTargetPicker([
          {
            type: 'flex',
            altText: altText,
            contents: flexContent
          }
        ]);
        
        debugLog('‚úÖ Share successful');
        hideLoading();
        showSuccess('‚úÖ ‡πÅ‡∏ä‡∏£‡πå Flex Message ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        setTimeout(() => {
          debugLog('üîí Closing window...');
          liff.closeWindow();
        }, 2000);
        
      } catch (err) {
        debugLog('‚ùå Share Error', err);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (err.message && (err.message.includes('cancel') || err.message.includes('closed'))) {
          showError('‚ÑπÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå Flex Message');
        } else {
          showError('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ', err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå');
        }
        
        setTimeout(() => liff.closeWindow(), 3000);
      }
    }
    
    // Helper functions
    function hideLoading() {
      document.querySelector('.loading').style.display = 'none';
    }
    
    function showError(title, message) {
      hideLoading();
      const errorDiv = document.getElementById('error');
      errorDiv.style.display = 'block';
      errorDiv.innerHTML = `
        <div class="icon">‚ùå</div>
        <strong>${title}</strong><br>
        <div style="margin-top: 10px; font-size: 14px;">${message}</div>
      `;
      debugLog('üî¥ Error displayed', { title, message });
    }
    
    function showSuccess(message) {
      hideLoading();
      const successDiv = document.getElementById('success');
      successDiv.style.display = 'block';
      successDiv.innerHTML = `
        <div class="icon">‚úÖ</div>
        <strong>${message}</strong><br>
        <div style="margin-top: 10px; font-size: 14px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á...</div>
      `;
      debugLog('üü¢ Success displayed', { message });
    }
  </script>
</body>
</html>
